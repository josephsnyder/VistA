#---------------------------------------------------------------------------
# Copyright 2012 The Open Source Electronic Health Record Agent
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#---------------------------------------------------------------------------
import sys
sys.path = ['${VISTA_SOURCE_DIR}/Python'] + sys.path

from OSEHRAHelper import ConnectToMUMPS,PROMPT
VistA=ConnectToMUMPS("${VISTA_BINARY_DIR}/Testing/Log/AddAppointment.log","${INSTANCE}","${NAMESPACE}")
if ('${USERNAME}' and '${PASSWORD}'):
  VistA.login('${USERNAME}','${PASSWORD}')
if VistA.type=='cache':
  try:
    VistA.ZN('${NAMESPACE}')
  except IndexError,no_namechange:
    pass

VistA.wait(PROMPT)
VistA.write('S DUZ=1 D ^XUP')
VistA.wait('Select OPTION NAME')
VistA.write('SDUSER')
VistA.wait('Menu Option')
VistA.write('Appointment Menu')
VistA.wait('Appointment Menu Option')
VistA.write('Make Appointment')
VistA.wait('Select CLINIC')
VistA.write(sys.argv[4])
VistA.wait('Select PATIENT NAME')
VistA.write(sys.argv[5])
VistA.wait('APPOINTMENT TYPE')
VistA.write('REGULAR')
index = VistA.multiwait(['APPOINTMENT REQUEST','DISPLAY PENDING APPOINTMENTS'])
#
#
#  If patient data was not added during registration(GTM or errors on Cache)
#  This will ask for a bunch of info on the patient. need to code up still.
# Select ETHNICITY:
# Select RACE:
# COUNTRY: UNITED STATES// UNITED STATES  USA     United States
# STREET ADDRESS [LINE 1]:
# ZIP+4:
# PHONE NUMBER [RESIDENCE]:
# PHONE NUMBER [WORK]:
# BAD ADDRESS INDICATOR:
# Are you sure that you want to save the above changes?
# This is a required response. Enter '^' to exit
#
#
if index==1:
  VistA.write('Yes')
  VistA.wait('APPOINTMENT REQUEST')
elif index==2:
  VistA.write('\r')
VistA.write('Yes')
VistA.wait("DATE/TIME")
VistA.write(sys.argv[1]+'@'+sys.argv[2])
index = VistA.multiwait(['LENGTH OF APPOINTMENT','DATE/TIME','DO YOU WANT TO CANCEL IT','Add to EWL','PATIENT ALREADY HAS APPOINTMENT ON THE SAME DAY'])
if index==1:
  sys.exit(0)
elif index == 2 or index == 3 or index == 4:
  VistA.write('No')
  sys.exit(0)
VistA.write(sys.argv[3])
VistA.wait('IS THIS CORRECT')
VistA.write('Yes')
VistA.wait('WANT PATIENT NOTIFIED')
VistA.write('No')
VistA.wait('OTHER INFO')
VistA.write('')
VistA.wait('SENT TO CLINIC')
VistA.write('No')
VistA.wait('Press RETURN to continue')
VistA.write('\r\r\r')
